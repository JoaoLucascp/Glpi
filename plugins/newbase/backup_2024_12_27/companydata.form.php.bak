<?php
/**
 * Company Data Form - VERSÃO CORRIGIDA E SIMPLIFICADA
 * 
 * @package   PluginNewbase
 * @author    João Lucas
 * @license   GPLv2+
 * @since     2.0.0
 */

// Include GLPI
include('../../../inc/includes.php');

// Check login
Session::checkLoginUser();

// Check rights
Session::checkRight('plugin_newbase_companydata', READ);

// Create object
$company = new PluginNewbaseCompanyData();

// ========== HANDLE FORM SUBMISSIONS ==========

if (isset($_POST['add'])) {
    // ADD NEW COMPANY
    $company->check(-1, CREATE, $_POST);
    
    if ($newID = $company->add($_POST)) {
        Event::log(
            $newID, 
            "PluginNewbaseCompanyData", 
            4, 
            "newbase", 
            sprintf(__('%1$s adds the item %2$s'), $_SESSION["glpiname"], $_POST["name"] ?? '')
        );
        
        Session::addMessageAfterRedirect('✅ Empresa adicionada com sucesso!', false, INFO);
        
        if ($_SESSION['glpibackcreated']) {
            Html::redirect($company->getFormURLWithID($newID));
        }
    }
    Html::back();
    
} else if (isset($_POST['update'])) {
    // UPDATE COMPANY
    $company->check($_POST['id'], UPDATE);
    
    if ($company->update($_POST)) {
        Event::log(
            $_POST['id'], 
            "PluginNewbaseCompanyData", 
            4, 
            "newbase",
            sprintf(__('%s updates an item'), $_SESSION["glpiname"])
        );
        
        Session::addMessageAfterRedirect('✅ Empresa atualizada com sucesso!', false, INFO);
    }
    Html::back();
    
} else if (isset($_POST['delete'])) {
    // DELETE COMPANY (soft delete)
    $company->check($_POST['id'], DELETE);
    
    if ($company->delete($_POST)) {
        Event::log(
            $_POST['id'], 
            "PluginNewbaseCompanyData", 
            4, 
            "newbase",
            sprintf(__('%s deletes an item'), $_SESSION["glpiname"])
        );
        
        Session::addMessageAfterRedirect('✅ Empresa excluída com sucesso!', false, INFO);
    }
    Html::redirect($CFG_GLPI['root_doc'] . "/plugins/newbase/front/companydata.php");
    
} else if (isset($_POST['restore'])) {
    // RESTORE COMPANY
    $company->check($_POST['id'], DELETE);
    
    if ($company->restore($_POST)) {
        Event::log(
            $_POST['id'], 
            "PluginNewbaseCompanyData", 
            4, 
            "newbase",
            sprintf(__('%s restores an item'), $_SESSION["glpiname"])
        );
        
        Session::addMessageAfterRedirect('✅ Empresa restaurada com sucesso!', false, INFO);
    }
    Html::redirect($CFG_GLPI['root_doc'] . "/plugins/newbase/front/companydata.php");
    
} else if (isset($_POST['purge'])) {
    // PURGE COMPANY (permanent delete)
    $company->check($_POST['id'], PURGE);
    
    if ($company->delete($_POST, 1)) {
        Event::log(
            $_POST['id'], 
            "PluginNewbaseCompanyData", 
            4, 
            "newbase",
            sprintf(__('%s purges an item'), $_SESSION["glpiname"])
        );
        
        Session::addMessageAfterRedirect('✅ Empresa removida permanentemente!', false, INFO);
    }
    Html::redirect($CFG_GLPI['root_doc'] . "/plugins/newbase/front/companydata.php");
    
} else {
    // ========== DISPLAY FORM ==========
    
    // Get ID from URL
    $id = $_GET['id'] ?? 0;
    
    // Display header
    Html::header(
        PluginNewbaseCompanyData::getTypeName(1), 
        $_SERVER['PHP_SELF'], 
        "management", 
        "PluginNewbaseCompanyData"
    );
    
    // Check permissions and display form
    if ($id > 0) {
        $company->check($id, READ);
    } else {
        $company->check(-1, CREATE);
    }
    
    // Display the form using the showForm() method
    $company->display(['id' => $id]);
    
    // Display footer
    Html::footer();
}
