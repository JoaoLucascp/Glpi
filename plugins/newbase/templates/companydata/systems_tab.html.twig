{#
 ┌─────────────────────────────────────────────────────────────────────┐
 │  ABA: Configurações de Sistemas — Plugin Newbase                    │
 │  Template: @newbase/companydata/systems_tab.html.twig               │
 │  Variáveis recebidas de CompanyData::showSystemsConfigTab():        │
 │    item_id   int     — ID do registro em company_extras             │
 │    form_url  string  — URL de update (front/companydata.form.php)   │
 │    csrf_token string — Token CSRF da sessão                         │
 │    ipbx      array   — config IPBX/PABX                            │
 │    ipbx_cloud array  — config IPBX Cloud                           │
 │    chatbot   array   — config Chatbot                               │
 │    linha     array   — config Linha Telefônica                      │
 └─────────────────────────────────────────────────────────────────────┘
#}

<div class="newbase-systems-wrapper">

    {# ═══════════════════════════════════════════════════════
       Formulário principal — POST via AJAX para endpoint dedicado
       ═══════════════════════════════════════════════════════ #}
    <form id="nb-systems-form" method="post" novalidate>
        <input type="hidden" name="id"               value="{{ item_id }}">
        <input type="hidden" name="_glpi_csrf_token" value="{{ csrf_token }}">

        {# ════════════════════════════════════════════════════
           ACCORDION PRINCIPAL
           ════════════════════════════════════════════════════ #}
        <div class="accordion accordion-flush nb-accordion" id="nbSystemsAccordion">

            {# ──────────────────────────────────────────────────
               1. IPBX / PABX
               ────────────────────────────────────────────────── #}
            <div class="accordion-item nb-accordion-item">
                <h2 class="accordion-header" id="hIPBX">
                    <button class="accordion-button nb-accordion-btn"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#pIPBX"
                            aria-expanded="true"
                            aria-controls="pIPBX">
                        <i class="ti ti-phone-call text-primary me-2"></i>
                        <strong>IPBX / PABX</strong>
                        <span class="badge bg-primary-lt ms-2 text-primary">Servidor de Telefonia</span>
                    </button>
                </h2>
                <div id="pIPBX" class="accordion-collapse collapse show" aria-labelledby="hIPBX">
                    <div class="accordion-body">

                        {# ── Sub-seção: Informações do Servidor ──────────── #}
                        <p class="nb-section-label">
                            <i class="ti ti-server me-1"></i> Informações do Servidor
                        </p>
                        <div class="row g-3 mb-4">

                            <div class="col-12 col-lg-6">
                                <label class="form-label">Modelo</label>
                                <input type="text"
                                       name="systems_config[ipbx][model]"
                                       value="{{ ipbx.model ?? '' }}"
                                       class="form-control nb-fc"
                                       placeholder="Ex: NewCloud, Issabel, FreePBX">
                            </div>

                            <div class="col-12 col-lg-6">
                                <label class="form-label">Versão do Servidor</label>
                                <input type="text"
                                       name="systems_config[ipbx][version]"
                                       value="{{ ipbx.version ?? '' }}"
                                       class="form-control nb-fc"
                                       placeholder="Ex: 3.19">
                            </div>

                            <div class="col-12 col-lg-6">
                                <label class="form-label">IP Interno</label>
                                <input type="text"
                                       name="systems_config[ipbx][internal_ip]"
                                       value="{{ ipbx.internal_ip ?? '' }}"
                                       class="form-control nb-fc"
                                       placeholder="Ex: 192.168.0.10">
                            </div>

                            <div class="col-12 col-lg-6">
                                <label class="form-label">IP Externo</label>
                                <input type="text"
                                       name="systems_config[ipbx][external_ip]"
                                       value="{{ ipbx.external_ip ?? '' }}"
                                       class="form-control nb-fc"
                                       placeholder="Ex: 200.x.x.x">
                            </div>

                            <div class="col-12 col-lg-6">
                                <label class="form-label">Porta Acesso Web</label>
                                <input type="text"
                                       name="systems_config[ipbx][web_port]"
                                       value="{{ ipbx.web_port ?? '' }}"
                                       class="form-control nb-fc"
                                       placeholder="Ex: 2080">
                            </div>

                            <div class="col-12 col-lg-6">
                                <label class="form-label nb-pwd-label">
                                    Senha Acesso Web
                                    <span class="badge bg-warning-lt text-warning ms-1 fw-normal">visível</span>
                                </label>
                                {# type=text por requisito: senhas visíveis por padrão #}
                                <input type="text"
                                       name="systems_config[ipbx][web_password]"
                                       value="{{ ipbx.web_password ?? '' }}"
                                       class="form-control nb-fc nb-pwd"
                                       placeholder="Senha de acesso web"
                                       autocomplete="off">
                            </div>

                            <div class="col-12 col-lg-6">
                                <label class="form-label">Porta Acesso SSH</label>
                                <input type="text"
                                       name="systems_config[ipbx][ssh_port]"
                                       value="{{ ipbx.ssh_port ?? '' }}"
                                       class="form-control nb-fc"
                                       placeholder="Ex: 2022">
                            </div>

                            <div class="col-12 col-lg-6">
                                <label class="form-label nb-pwd-label">
                                    Senha Acesso SSH
                                    <span class="badge bg-warning-lt text-warning ms-1 fw-normal">visível</span>
                                </label>
                                {# type=text por requisito: senhas visíveis por padrão #}
                                <input type="text"
                                       name="systems_config[ipbx][ssh_password]"
                                       value="{{ ipbx.ssh_password ?? '' }}"
                                       class="form-control nb-fc nb-pwd"
                                       placeholder="Senha SSH"
                                       autocomplete="off">
                            </div>

                            <div class="col-12">
                                <label class="form-label">Observações</label>
                                <textarea name="systems_config[ipbx][observations]"
                                          class="form-control nb-fc"
                                          rows="3"
                                          placeholder="Observações adicionais sobre o servidor...">{{ ipbx.observations ?? '' }}</textarea>
                            </div>

                        </div>{# /.row Informações do Servidor #}

                        {# ── Sub-seção: Ramais ─────────────────────────── #}
                        <p class="nb-section-label">
                            <i class="ti ti-device-mobile me-1"></i> Ramais
                        </p>
                        <div class="table-responsive mb-2">
                            <table class="table table-sm nb-table align-middle" id="nb-ipbx-ramais-table">
                                <thead class="table-light">
                                    <tr>
                                        <th>Ramal</th>
                                        <th>Senha</th>
                                        <th>IP Aparelho</th>
                                        <th>Nome</th>
                                        <th>Localidade</th>
                                        <th>Gravação</th>
                                        <th>Observações</th>
                                        <th style="width:40px"></th>
                                    </tr>
                                </thead>
                                <tbody id="nb-ipbx-ramais-body">
                                    {% for ramal in ipbx.ramais ?? [] %}
                                    <tr class="nb-ramal-row">
                                        <td>
                                            <input type="text"
                                                   class="form-control nb-fc form-control-sm"
                                                   name="systems_config[ipbx][ramais][{{ loop.index0 }}][ramal]"
                                                   value="{{ ramal.ramal ?? '' }}"
                                                   placeholder="2001">
                                        </td>
                                        <td>
                                            <input type="text"
                                                   class="form-control nb-fc nb-pwd form-control-sm"
                                                   name="systems_config[ipbx][ramais][{{ loop.index0 }}][senha]"
                                                   value="{{ ramal.senha ?? '' }}"
                                                   placeholder="senha"
                                                   autocomplete="off">
                                        </td>
                                        <td>
                                            <input type="text"
                                                   class="form-control nb-fc form-control-sm"
                                                   name="systems_config[ipbx][ramais][{{ loop.index0 }}][ip]"
                                                   value="{{ ramal.ip ?? '' }}"
                                                   placeholder="192.168.x.x">
                                        </td>
                                        <td>
                                            <input type="text"
                                                   class="form-control nb-fc form-control-sm"
                                                   name="systems_config[ipbx][ramais][{{ loop.index0 }}][nome]"
                                                   value="{{ ramal.nome ?? '' }}"
                                                   placeholder="Ex: José">
                                        </td>
                                        <td>
                                            <input type="text"
                                                   class="form-control nb-fc form-control-sm"
                                                   name="systems_config[ipbx][ramais][{{ loop.index0 }}][localidade]"
                                                   value="{{ ramal.localidade ?? '' }}"
                                                   placeholder="Financeiro">
                                        </td>
                                        <td>
                                            <select class="form-select nb-fc form-select-sm"
                                                    name="systems_config[ipbx][ramais][{{ loop.index0 }}][gravacao]">
                                                <option value="nao" {{ (ramal.gravacao ?? 'nao') == 'nao' ? 'selected' : '' }}>Não</option>
                                                <option value="sim" {{ (ramal.gravacao ?? '') == 'sim' ? 'selected' : '' }}>Sim</option>
                                            </select>
                                        </td>
                                        <td>
                                            <input type="text"
                                                   class="form-control nb-fc form-control-sm"
                                                   name="systems_config[ipbx][ramais][{{ loop.index0 }}][obs]"
                                                   value="{{ ramal.obs ?? '' }}"
                                                   placeholder="...">
                                        </td>
                                        <td>
                                            <button type="button"
                                                    class="btn btn-sm btn-danger nb-remove-row"
                                                    data-body="nb-ipbx-ramais-body"
                                                    title="Remover ramal">
                                                <i class="ti ti-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <button type="button"
                                class="btn btn-sm btn-outline-primary"
                                id="nb-btn-add-ramal">
                            <i class="ti ti-plus me-1"></i> Adicionar Ramal
                        </button>

                        {# ── Sub-seção: Informações de Operadora ───────── #}
                        <p class="nb-section-label mt-4">
                            <i class="ti ti-building-broadcast-tower me-1"></i> Informações de Operadora (Troncos)
                        </p>
                        <div class="table-responsive mb-2">
                            <table class="table table-sm nb-table align-middle" id="nb-ipbx-ops-table">
                                <thead class="table-light">
                                    <tr>
                                        <th>Nº Piloto</th>
                                        <th>Tipo Tronco</th>
                                        <th>Operadora</th>
                                        <th>DDR</th>
                                        <th>Canais</th>
                                        <th>IP Proxy</th>
                                        <th>Porta Proxy</th>
                                        <th>IP Áudio</th>
                                        <th style="width:40px"></th>
                                    </tr>
                                </thead>
                                <tbody id="nb-ipbx-ops-body">
                                    {% for op in ipbx.operadoras ?? [] %}
                                    <tr class="nb-op-row">
                                        <td><input type="text" class="form-control nb-fc form-control-sm" name="systems_config[ipbx][operadoras][{{ loop.index0 }}][numero_piloto]" value="{{ op.numero_piloto ?? '' }}" placeholder="(27)3xxx-xxxx"></td>
                                        <td><input type="text" class="form-control nb-fc form-control-sm" name="systems_config[ipbx][operadoras][{{ loop.index0 }}][tipo_tronco]"   value="{{ op.tipo_tronco ?? '' }}"   placeholder="SIP"></td>
                                        <td><input type="text" class="form-control nb-fc form-control-sm" name="systems_config[ipbx][operadoras][{{ loop.index0 }}][operadora]"     value="{{ op.operadora ?? '' }}"     placeholder="Vivo"></td>
                                        <td><input type="text" class="form-control nb-fc form-control-sm" name="systems_config[ipbx][operadoras][{{ loop.index0 }}][ddr]"           value="{{ op.ddr ?? '' }}"           placeholder="33727000-7100"></td>
                                        <td><input type="number" class="form-control nb-fc form-control-sm" name="systems_config[ipbx][operadoras][{{ loop.index0 }}][canais]"      value="{{ op.canais ?? '' }}"        placeholder="10" min="1"></td>
                                        <td><input type="text" class="form-control nb-fc form-control-sm" name="systems_config[ipbx][operadoras][{{ loop.index0 }}][ip_proxy]"     value="{{ op.ip_proxy ?? '' }}"     placeholder="192.x.x.x"></td>
                                        <td><input type="text" class="form-control nb-fc form-control-sm" name="systems_config[ipbx][operadoras][{{ loop.index0 }}][porta_proxy]"  value="{{ op.porta_proxy ?? '' }}"  placeholder="5060"></td>
                                        <td><input type="text" class="form-control nb-fc form-control-sm" name="systems_config[ipbx][operadoras][{{ loop.index0 }}][ip_audio]"     value="{{ op.ip_audio ?? '' }}"     placeholder="192.x.x.x"></td>
                                        <td>
                                            <button type="button"
                                                    class="btn btn-sm btn-danger nb-remove-row"
                                                    data-body="nb-ipbx-ops-body"
                                                    title="Remover operadora">
                                                <i class="ti ti-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <button type="button"
                                class="btn btn-sm btn-outline-secondary"
                                id="nb-btn-add-operadora">
                            <i class="ti ti-plus me-1"></i> Adicionar Operadora
                        </button>

                    </div>{# /.accordion-body IPBX #}
                </div>
            </div>{# /.accordion-item IPBX #}

            {# ──────────────────────────────────────────────────
               2. IPBX CLOUD
               ────────────────────────────────────────────────── #}
            <div class="accordion-item nb-accordion-item">
                <h2 class="accordion-header" id="hCloud">
                    <button class="accordion-button nb-accordion-btn collapsed"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#pCloud"
                            aria-expanded="false"
                            aria-controls="pCloud">
                        <i class="ti ti-cloud text-cyan me-2"></i>
                        <strong>IPBX Cloud</strong>
                        <span class="badge bg-cyan-lt ms-2 text-cyan">Servidor em Nuvem</span>
                    </button>
                </h2>
                <div id="pCloud" class="accordion-collapse collapse" aria-labelledby="hCloud">
                    <div class="accordion-body">

                        <p class="nb-section-label">
                            <i class="ti ti-server me-1"></i> Informações do Servidor Cloud
                        </p>
                        <div class="row g-3">

                            <div class="col-12 col-lg-6">
                                <label class="form-label">Modelo</label>
                                <input type="text"
                                       name="systems_config[ipbx_cloud][model]"
                                       value="{{ ipbx_cloud.model ?? '' }}"
                                       class="form-control nb-fc"
                                       placeholder="Ex: VoIP.ms, 3CX Cloud, Twilio">
                            </div>

                            <div class="col-12 col-lg-6">
                                <label class="form-label">Versão</label>
                                <input type="text"
                                       name="systems_config[ipbx_cloud][version]"
                                       value="{{ ipbx_cloud.version ?? '' }}"
                                       class="form-control nb-fc"
                                       placeholder="Ex: 19.0">
                            </div>

                            <div class="col-12 col-lg-6">
                                <label class="form-label">IP Interno</label>
                                <input type="text"
                                       name="systems_config[ipbx_cloud][internal_ip]"
                                       value="{{ ipbx_cloud.internal_ip ?? '' }}"
                                       class="form-control nb-fc"
                                       placeholder="Ex: 10.0.0.1">
                            </div>

                            <div class="col-12 col-lg-6">
                                <label class="form-label">Host / IP Externo</label>
                                <input type="text"
                                       name="systems_config[ipbx_cloud][external_ip]"
                                       value="{{ ipbx_cloud.external_ip ?? '' }}"
                                       class="form-control nb-fc"
                                       placeholder="Ex: pbx.empresa.com ou 200.x.x.x">
                            </div>

                            <div class="col-12 col-lg-6">
                                <label class="form-label">Porta Acesso Web</label>
                                <input type="text"
                                       name="systems_config[ipbx_cloud][web_port]"
                                       value="{{ ipbx_cloud.web_port ?? '' }}"
                                       class="form-control nb-fc"
                                       placeholder="Ex: 5001">
                            </div>

                            <div class="col-12 col-lg-6">
                                <label class="form-label nb-pwd-label">
                                    Senha Acesso Web
                                    <span class="badge bg-warning-lt text-warning ms-1 fw-normal">visível</span>
                                </label>
                                <input type="text"
                                       name="systems_config[ipbx_cloud][web_password]"
                                       value="{{ ipbx_cloud.web_password ?? '' }}"
                                       class="form-control nb-fc nb-pwd"
                                       placeholder="Senha web"
                                       autocomplete="off">
                            </div>

                            <div class="col-12 col-lg-6">
                                <label class="form-label">Porta SSH</label>
                                <input type="text"
                                       name="systems_config[ipbx_cloud][ssh_port]"
                                       value="{{ ipbx_cloud.ssh_port ?? '' }}"
                                       class="form-control nb-fc"
                                       placeholder="Ex: 22">
                            </div>

                            <div class="col-12 col-lg-6">
                                <label class="form-label nb-pwd-label">
                                    Senha SSH
                                    <span class="badge bg-warning-lt text-warning ms-1 fw-normal">visível</span>
                                </label>
                                <input type="text"
                                       name="systems_config[ipbx_cloud][ssh_password]"
                                       value="{{ ipbx_cloud.ssh_password ?? '' }}"
                                       class="form-control nb-fc nb-pwd"
                                       placeholder="Senha SSH"
                                       autocomplete="off">
                            </div>

                            <div class="col-12">
                                <label class="form-label">Observações</label>
                                <textarea name="systems_config[ipbx_cloud][observations]"
                                          class="form-control nb-fc"
                                          rows="3"
                                          placeholder="Observações do servidor em nuvem...">{{ ipbx_cloud.observations ?? '' }}</textarea>
                            </div>

                        </div>{# /.row #}
                    </div>
                </div>
            </div>{# /.accordion-item Cloud #}

            {# ──────────────────────────────────────────────────
               3. CHATBOT
               ────────────────────────────────────────────────── #}
            <div class="accordion-item nb-accordion-item">
                <h2 class="accordion-header" id="hChatbot">
                    <button class="accordion-button nb-accordion-btn collapsed"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#pChatbot"
                            aria-expanded="false"
                            aria-controls="pChatbot">
                        <i class="ti ti-robot text-green me-2"></i>
                        <strong>Chatbot</strong>
                        <span class="badge bg-success-lt ms-2 text-success">Omnichannel</span>
                    </button>
                </h2>
                <div id="pChatbot" class="accordion-collapse collapse" aria-labelledby="hChatbot">
                    <div class="accordion-body">
                        <div class="row g-3">

                            <div class="col-12 col-lg-6">
                                <label class="form-label">Plataforma</label>
                                <input type="text"
                                       name="systems_config[chatbot][platform]"
                                       value="{{ chatbot.platform ?? '' }}"
                                       class="form-control nb-fc"
                                       placeholder="Ex: Chatwoot, Zenvia, Take Blip, ChatGPT">
                            </div>

                            <div class="col-12 col-lg-6">
                                <label class="form-label nb-pwd-label">
                                    API Key
                                    <span class="badge bg-warning-lt text-warning ms-1 fw-normal">visível</span>
                                </label>
                                <input type="text"
                                       name="systems_config[chatbot][api_key]"
                                       value="{{ chatbot.api_key ?? '' }}"
                                       class="form-control nb-fc nb-pwd"
                                       placeholder="Chave de API da plataforma"
                                       autocomplete="off">
                            </div>

                            <div class="col-12">
                                <label class="form-label">Configuração / Notas</label>
                                <textarea name="systems_config[chatbot][config]"
                                          class="form-control nb-fc"
                                          rows="4"
                                          placeholder="Webhooks, endpoints, configurações adicionais...">{{ chatbot.config ?? '' }}</textarea>
                            </div>

                        </div>
                    </div>
                </div>
            </div>{# /.accordion-item Chatbot #}

            {# ──────────────────────────────────────────────────
               4. LINHA TELEFÔNICA
               ────────────────────────────────────────────────── #}
            <div class="accordion-item nb-accordion-item">
                <h2 class="accordion-header" id="hLinha">
                    <button class="accordion-button nb-accordion-btn collapsed"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#pLinha"
                            aria-expanded="false"
                            aria-controls="pLinha">
                        <i class="ti ti-phone text-orange me-2"></i>
                        <strong>Linha Telefônica</strong>
                        <span class="badge bg-orange-lt ms-2 text-orange">Linha Fixa</span>
                    </button>
                </h2>
                <div id="pLinha" class="accordion-collapse collapse" aria-labelledby="hLinha">
                    <div class="accordion-body">
                        <div class="row g-3">

                            <div class="col-12 col-lg-6">
                                <label class="form-label">Operadora</label>
                                <input type="text"
                                       name="systems_config[linha][operadora]"
                                       value="{{ linha.operadora ?? '' }}"
                                       class="form-control nb-fc"
                                       placeholder="Ex: Claro, Vivo, TIM, Oi">
                            </div>

                            <div class="col-12 col-lg-6">
                                <label class="form-label">Número do Contrato</label>
                                <input type="text"
                                       name="systems_config[linha][contrato]"
                                       value="{{ linha.contrato ?? '' }}"
                                       class="form-control nb-fc"
                                       placeholder="Número ou código do contrato">
                            </div>

                            <div class="col-12">
                                <label class="form-label">Notas</label>
                                <textarea name="systems_config[linha][notas]"
                                          class="form-control nb-fc"
                                          rows="3"
                                          placeholder="Informações adicionais sobre a linha telefônica...">{{ linha.notas ?? '' }}</textarea>
                            </div>

                        </div>
                    </div>
                </div>
            </div>{# /.accordion-item Linha #}

        </div>{# /.accordion #}

        {# ════════════════════════════════════════════════════
           BOTÃO SALVAR
           ════════════════════════════════════════════════════ #}
        <div class="text-center mt-4 pb-2">
            <button type="submit" class="btn btn-primary nb-save-btn" id="nb-systems-save-btn">
                <i class="ti ti-device-floppy me-2"></i>
                Salvar Configurações de Sistemas
            </button>
        </div>

    </form>
</div>{# /.newbase-systems-wrapper #}

{# ═══════════════════════════════════════════════════════════════
   JAVASCRIPT INLINE — Ramais, Operadoras dinâmicos + AJAX save
   ═══════════════════════════════════════════════════════════════ #}
<script>
(function ($) {
    'use strict';

    // ── Helpers ─────────────────────────────────────────────────

    /**
     * Renumera os índices dos campos de uma tbody após remover linha.
     * Substitui [N][ no final de cada name= pelo índice correto.
     */
    function renumerarLinhas(tbodyId) {
        $('#' + tbodyId + ' tr').each(function (i) {
            $(this).find('input, select, textarea').each(function () {
                var name = $(this).attr('name');
                if (!name) return;
                // Ex: systems_config[ipbx][ramais][3][ramal] → [i][ramal]
                $(this).attr('name', name.replace(/\]\[(\d+)\]\[/, '][' + i + ']['));
            });
        });
    }

    /**
     * Gera HTML de uma linha de ramal vazia.
     */
    function novaLinhaRamal(idx) {
        var p = 'systems_config[ipbx][ramais][' + idx + ']';
        return '<tr class="nb-ramal-row nb-row-new">'
            + '<td><input type="text"   class="form-control nb-fc form-control-sm" name="' + p + '[ramal]"      placeholder="2001"></td>'
            + '<td><input type="text"   class="form-control nb-fc nb-pwd form-control-sm" name="' + p + '[senha]" placeholder="senha" autocomplete="off"></td>'
            + '<td><input type="text"   class="form-control nb-fc form-control-sm" name="' + p + '[ip]"         placeholder="192.168.x.x"></td>'
            + '<td><input type="text"   class="form-control nb-fc form-control-sm" name="' + p + '[nome]"       placeholder="Ex: José"></td>'
            + '<td><input type="text"   class="form-control nb-fc form-control-sm" name="' + p + '[localidade]" placeholder="Financeiro"></td>'
            + '<td><select class="form-select nb-fc form-select-sm" name="' + p + '[gravacao]">'
            +     '<option value="nao">Não</option><option value="sim">Sim</option>'
            + '</select></td>'
            + '<td><input type="text"   class="form-control nb-fc form-control-sm" name="' + p + '[obs]"        placeholder="..."></td>'
            + '<td><button type="button" class="btn btn-sm btn-danger nb-remove-row" data-body="nb-ipbx-ramais-body" title="Remover"><i class="ti ti-trash"></i></button></td>'
            + '</tr>';
    }

    /**
     * Gera HTML de uma linha de operadora vazia.
     */
    function novaLinhaOperadora(idx) {
        var p = 'systems_config[ipbx][operadoras][' + idx + ']';
        return '<tr class="nb-op-row nb-row-new">'
            + '<td><input type="text"   class="form-control nb-fc form-control-sm" name="' + p + '[numero_piloto]" placeholder="(27)3xxx-xxxx"></td>'
            + '<td><input type="text"   class="form-control nb-fc form-control-sm" name="' + p + '[tipo_tronco]"   placeholder="SIP"></td>'
            + '<td><input type="text"   class="form-control nb-fc form-control-sm" name="' + p + '[operadora]"     placeholder="Vivo"></td>'
            + '<td><input type="text"   class="form-control nb-fc form-control-sm" name="' + p + '[ddr]"           placeholder="33727000-7100"></td>'
            + '<td><input type="number" class="form-control nb-fc form-control-sm" name="' + p + '[canais]"        placeholder="10" min="1"></td>'
            + '<td><input type="text"   class="form-control nb-fc form-control-sm" name="' + p + '[ip_proxy]"      placeholder="192.x.x.x"></td>'
            + '<td><input type="text"   class="form-control nb-fc form-control-sm" name="' + p + '[porta_proxy]"   placeholder="5060"></td>'
            + '<td><input type="text"   class="form-control nb-fc form-control-sm" name="' + p + '[ip_audio]"      placeholder="192.x.x.x"></td>'
            + '<td><button type="button" class="btn btn-sm btn-danger nb-remove-row" data-body="nb-ipbx-ops-body" title="Remover"><i class="ti ti-trash"></i></button></td>'
            + '</tr>';
    }

    // ── Adicionar Ramal ──────────────────────────────────────────
    $(document).on('click', '#nb-btn-add-ramal', function () {
        var $body = $('#nb-ipbx-ramais-body');
        $body.append(novaLinhaRamal($body.find('tr').length));
        // Foca o primeiro campo da nova linha
        $body.find('tr:last input:first').trigger('focus');
    });

    // ── Adicionar Operadora ──────────────────────────────────────
    $(document).on('click', '#nb-btn-add-operadora', function () {
        var $body = $('#nb-ipbx-ops-body');
        $body.append(novaLinhaOperadora($body.find('tr').length));
        $body.find('tr:last input:first').trigger('focus');
    });

    // ── Remover linha (Ramal ou Operadora) ───────────────────────
    $(document).on('click', '.nb-remove-row', function () {
        var bodyId = $(this).data('body');
        $(this).closest('tr').remove();
        renumerarLinhas(bodyId);
    });

    // ── Interceptar submit → AJAX com SweetAlert2 ───────────────
    $('#nb-systems-form').on('submit', function (e) {
        e.preventDefault();

        var $form = $(this);
        var $btn  = $('#nb-systems-save-btn');

        $btn.prop('disabled', true)
            .html('<span class="nb-spin d-inline-block me-2">⟳</span> Salvando...');

        // URL do endpoint AJAX dedicado (na mesma pasta ajax/ do plugin)
        var ajaxUrl = (typeof CFG_GLPI !== 'undefined' ? CFG_GLPI.root_doc : '')
                    + '/plugins/newbase/ajax/systemsConfig.php';

        $.ajax({
            type    : 'POST',
            url     : ajaxUrl,
            data    : $form.serialize(),
            dataType: 'json',
            timeout : 15000,
            success : function (res) {
                $btn.prop('disabled', false)
                    .html('<i class="ti ti-device-floppy me-2"></i> Salvar Configurações de Sistemas');

                if (res && res.success) {
                    _nbNotify('Configurações salvas com sucesso!', 'success');
                } else {
                    _nbNotify(res.message || 'Erro ao salvar configurações.', 'error');
                }
            },
            error   : function (xhr) {
                $btn.prop('disabled', false)
                    .html('<i class="ti ti-device-floppy me-2"></i> Salvar Configurações de Sistemas');

                var msg = 'Erro de comunicação com o servidor.';
                if (xhr.status === 403) msg = 'Sessão expirada. Recarregue a página.';
                if (xhr.status === 400) msg = 'Dados inválidos enviados.';
                _nbNotify(msg, 'error');
            }
        });
    });

    // ── Notificação: SweetAlert2 > GLPI toast > alert ────────────
    function _nbNotify(msg, type) {
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                icon              : type,
                text              : msg,
                toast             : (type === 'success'),
                position          : (type === 'success') ? 'top-end' : 'center',
                timer             : (type === 'success') ? 2500 : 0,
                showConfirmButton : (type !== 'success'),
                confirmButtonColor: '#206bc4'
            });
            return;
        }
        if (type === 'success' && typeof glpi_toast_info !== 'undefined') {
            glpi_toast_info(msg);
        } else if (type === 'error' && typeof glpi_toast_error !== 'undefined') {
            glpi_toast_error(msg);
        } else {
            alert(msg);
        }
    }

    // ── Injetar CSS de animação spin ─────────────────────────────
    if (!document.getElementById('nb-sys-spin-style')) {
        var s = document.createElement('style');
        s.id  = 'nb-sys-spin-style';
        s.textContent = '@keyframes nb-spin-anim{to{transform:rotate(360deg)}}'
                      + '.nb-spin{animation:nb-spin-anim .8s linear infinite;display:inline-block}';
        document.head.appendChild(s);
    }

})(jQuery);
</script>
